{% import 'macros.j2' as macros %}

<!-- StudyNavs -->
<nav>
    <div id="tabs" class="nav nav-tabs" role="tablist">
        {{ macros.render_nav_tabs(form) }}
    </div>
</nav>
<form id="sform" method="POST" action="">
        {{ form.hidden_tag() }}
    <div class="tab-content container-small">
        <!--Allgemein-->
        <div id="p1" class="tab-pane active">
            {{ macros.render_long_text(form.project_name) }}
            {{ macros.render_long_text(form.title) }}
            {{ macros.render_long_text(form.description) }}
            {{ macros.render_long_text(form.keywords) }}
            {#{ macros.render_date_bool(form.starting_date, form.starting_date_set)}#}
            {{ macros.render_int_unit(form.time_till_expiration) }}
            {{ macros.render_next_prev(1) }}
        </div>
        <div id="p2" class="tab-pane">
            {{ macros.render_int_bool(form.amount_workers, form.minibatch) }}
            {{ macros.render_decimal(form.payment_per_worker, form.qualification_name)}}
            {{ macros.render_int_unit(form.allotted_time_per_worker, 3) }}
            {{ macros.render_int_unit(form.accept_pay_worker_after, 3) }}
            {{ macros.render_next_prev(2) }}
        </div>
        <div id="p3" class="tab-pane">
            {{ macros.render_radio(form.must_be_master) }}

            <div id="qualifications" class="form-group">
                <div class="row">
                    <div class="col-8">
                        <label class='col-form-label'>Lege alle Qualifikationen fest (maximal 5)</label>
                    </div>
                </div>
                <div class="row">
                    <div class="col-auto">
                        <button type="button" id="add-select" class="btn btn-primary btn-sm">Qualifikation hinzufügen</button>
                        <button type="button" id="add-system" class="btn btn-success btn-sm">Standardqualifikationen
                            hinzufügen</button>
                    </div>
                </div>
            </div>

            <div class="form-group row">
                <div class="col-3">{{ form.adult_content.label}}</div>
                <div class="col">{{ form.adult_content}}</div>
            </div>
            {{ macros.render_radio(form.project_visibility, inline=false) }}

            {{ macros.render_next_prev(3) }}
        </div>
        <div id="p4" class="tab-pane">
            {{ form.editor_field}}
            {{ macros.render_next_prev(4) }}
        </div>
        <div id="p5" class="tab-pane">
            {{ form.submit }}
        </div>


    </div>
</form>
{{ ckeditor.load(custom_url=url_for('static', filename='ckeditor/ckeditor.js')) }}
{{ ckeditor.config(name='editor_field')}}

<script>

        $('form input').on('keypress', function(e) {
            return e.which !== 13;
        });

        $("#sform input").blur(function() {
            $(this.form).validate().element(this);
        });

        $("#sform").validate({
            ignore: "",
            rules:{
                starting_date: { // Maybe add rule for ---Select--- to be an invalid option and not allowing the same qual twice and ckeditor must not be empty
                    required: "#starting_date_set:unchecked"
                }
            },
            invalidHandler: function(e, validator){
                if(validator.errorList.length)
                    $('#tabs a[href="#' + $(validator.errorList[0].element).closest(".tab-pane").attr('id') + '"]').tab('show')
            },     
            errorPlacement: function(error, element) {
                if (element.prop("name") == "starting_date" )
                    error.insertAfter("#datetimepicker")
                else
                    error.insertAfter(element)
            }/*,
            submitHandler: function(form, event){
                //console.log("form"+form)
                //console.log(event)
                form.submit()
            }*/
        });

    $('form#sform').find('input').each(function(){
        var $input = $(this)
        var $label = $("label[for='"+$input.prop('id')+"']")
        if($input.prop('required') || $input.prop('id')=='starting_date'){ //if starting_date is shown it is required
            if($label.length != 0)
                $label.text($label.text()+"*")
        }
    });




    $(".optional-date").toggle($('#starting_date_set').prop("checked")==false); //if page reloaded after submit make sure that starting date is set appropriate

    $('#starting_date_set').on('change', function() {
        $(".optional-date").toggle(!this.checked);
    });

    
    $(".mbqual").toggle($('#minibatch').prop("checked"));   //if page reloaded after submit make sure that mbqual is set appropriately
    if($('#minibatch').prop("checked"))                     //if page reloaded after submit make sure that batches is set appropriately
        print_batches()

    $('#minibatch').on('change', function() {
        $(".mbqual").toggle(this.checked);
        this.checked?print_batches():$("#batches").hide()
    });
     
    $("#amount_workers").on('input', function(){
        var minibatch_box = $("#minibatch")
        if($(this).val()<10){
            minibatch_box.prop("disabled", true)
            minibatch_box.prop("checked", false)
            $("#batches").hide()
            $(".mbqual").hide()
        }else{
            minibatch_box.removeAttr("disabled")
            if(minibatch_box.is(':checked'))
                print_batches()
        }
    });

    function print_batches(){
        var amount =  $("#amount_workers").val()
        if (amount!=0){
            var full = Math.floor(amount/9)
            var full_string = (full==0 ? "" : full+"x9er")

            var part = amount%9
            var part_string = (part==0 ? "" : "1x"+part+"er")

            var connector = ((full_string!="" && part_string!="") ? " und ":"")
            
            var text = ":  Die Studie wird auf " + full_string + connector + part_string +" Batches aufgeteilt."

            $("#batches").text(text)
            $("#batches").show()
        }        
    }

    $(".next").click(function () {
        parent_id = $(this).parent().parent().parent().attr("id")
        int_id = parseInt(parent_id.substr(1))
        next_id = "#p" + (int_id + 1)
        $(".nav .nav-item[href='" + next_id + "']").trigger("click")
    });

    $(".prev").click(function () {
        parent_id = $(this).parent().parent().parent().attr("id")
        int_id = parseInt(parent_id.substr(1))
        prev_id = "#p" + (int_id - 1)
        $(".nav .nav-item[href='" + prev_id + "']").trigger("click")
    });


    (function($) {
        $.fn.inputFilter = function(inputFilter) {
        return this.on("input keydown keyup mousedown mouseup select contextmenu drop", function() {
            if (inputFilter(this.value)) {
            this.oldValue = this.value;
            this.oldSelectionStart = this.selectionStart;
            this.oldSelectionEnd = this.selectionEnd;
            } else if (this.hasOwnProperty("oldValue")) {
            this.value = this.oldValue;
            this.setSelectionRange(this.oldSelectionStart, this.oldSelectionEnd);
            }
        });
        };
    }(jQuery));

    // Payment for assignment < 10
    $(".currency").inputFilter(function(value){ return /^-?\d*[.,]?\d{0,2}$/.test(value) && (value === "" || parseFloat(value) <= 10)});
    $(".integer").inputFilter(function(value){ return /^\d*$/.test(value)});    
    
    $('#datetimepicker').datetimepicker({
        icons: {
            time: "far fa-clock",
            date: "far fa-calendar-alt",
            up: "fas fa-chevron-up",
            down: "fa fa-chevron-down",       
            previous: "fas fa-arrow-left",
            next: "fas fa-arrow-right",
            today: "fas fa-vial",
            clear: "fas fa-eraser",
            close: "far fa-times-circle"
        },
        locale: 'de',
        minDate:  moment()
    })
    
    $('i[data-toggle="tooltip"]').tooltip()
        
    

        

</script>

<script>
    var all_options=[];
    var qualifications = {{qualifications | tojson}}
    var percentage_interval = {{ qualification_percentage_interval }}
    var integer_list = {{ qualification_integer_list }}
    var countrycodes = {{ cc_list | tojson}}
    var sys_group = $("<optgroup label='System'></optgroup>")
    var custom_group =$("<optgroup label='Eigene'></optgroup>")
    
    qualifications.forEach(function (obj) {
            option_type = obj.Type ? 'system' : 'custom'
            option = {
                'type': option_type,
                'id': obj.QualificationTypeId,
                'name': obj.Name,
                'comparators': obj.Comparators,
                'value': obj.Value,
                'default': obj.Default
            }
            all_options.push(option)

            option = $("<option value=" + obj.QualificationTypeId + ">" + obj.Name + "</option>")
            if (obj.Type == "system")
                sys_group.append(option)
            else
         custom_group.append(option)
    })
    initDOMs()    
    
    function initDOMs(){
        var added=0
        $("button#add-system").click(function(){
            if(added==0){
                all_options.forEach(function(obj){
                    if (obj.type=="custom")
                        return
                    $row = create_qual_row()
                    $row.addClass("system-row")
                    $row.find("select option[value="+obj.id+"]").prop('selected',true).trigger('change');
                    $("#qualifications .row:first").after($row)
                    $('button#add-system').addClass('btn-danger').removeClass('btn-success').html("Standardqualifikationen entfernen")
                })
            }else{
                $("#qualifications .system-row").remove()
                $('button#add-system').addClass('btn-success').removeClass('btn-danger').html("Standardqualifikationen hinzufügen")
            }
            rearrange_ids()
            added = !added
            
        });
            
        // TODO: Hide visibility radios if no qualification was chosen
    
        $("button#add-select").click(function() { //reconstruct HTML to match wtform            
            $row = create_qual_row()
            $("#qualifications .row:last").before($row)
            rearrange_ids()            
        });

        $(document).on('click','.remove-row', function(){
            $(this).parents('.row').remove();
            rearrange_ids()
        })

        function create_qual_row(){
            btn = $("<a class='remove-row'><i class='fas fa-trash-alt'></i></a>")
            row = $("<div class='row selectorrow'></div>")
            col0= $("<div class='col-auto'><p class='index'>X</p></div>")
            col1= $("<div class='col-auto'></div>")
            col2= $("<div class='col-auto comparator'></div>")
            col3= $("<div class='col-auto value'></div>")
            col4= $("<div class='col-auto'></div>")

            select1 = $("<select id='qualifications_select-selects-X-selector'></select>")
            select2 = $("<select id='qualifications_select-selects-X-first_select'></select>")
            select3 = $("<select id='qualifications_select-selects-X-second_select'></select>")

            select1.on("change", function(){
                show_selects_for_option($(this))
            })

            option = $("<option value='false'>---Select---</option>")
            select1.append(option)
            select1.append(sys_group.clone())
            select1.append(custom_group.clone())
            col1.append(select1)
            col2.append(select2)
            col3.append(select3)
            col4.append(btn)
            row.append(col0)
            row.append(col1)
            row.append(col2)
            row.append(col3)
            row.append(col4)
            col2.hide() // Hide comparator by default
            col3.hide() // Hide values by default
            return row
        }

        function rearrange_ids(){
            $('#qualifications .selectorrow').each(function (index) {
                $(this).find('.index').text(index+1)
                $(this).find('select').each(function (){
                    var $selector = $(this)
                    var new_id = $selector.prop("id").replace(/\d+|X/g, index)  // RegEx: Gets number or X  (combination too, but w/e)
                    $selector.prop("id", new_id)
                    $selector.prop("name", new_id)
                })
            });
        }

        function show_selects_for_option($option){

            $parent = $option.closest(".selectorrow")
            $comparator_col = $parent.find(".comparator")
            $value_col = $parent.find(".value")

            $comparator_select = $comparator_col.children("select")
            $value_select = $value_col.children("select")
            
            $comparator_select.empty()
            $value_select.empty()
            
            $comparator_col.hide()
            $value_col.hide()

            if($option.val()=='false') // If select ---SELECT---  return
                return            
            
            var options = all_options.find(option => option.id === $option.val())

            if(!options)
                return
            
            if (options.comparators===undefined){   // Custom qualifications dont have the comparators-attribute set
                $option0 = $("<option value='Exists'>Existiert</option>")
                $option1 = $("<option value='DoesNotExist'>Existiert nicht</option>")
                $comparator_select.append($option0)
                $comparator_select.append($option1)
            }else{
                options.comparators.forEach(comparator => {
                    $option = $("<option value="+comparator.value+">"+comparator.name+"</option>")
                    $comparator_select.append($option)
                })                 
            }

            $comparator_col.show() //comparator is always shown (unless ---SELECT---)

            switch(options.value){
                case "PercentValue":
                    for(i=100;i>=0;i-=percentage_interval)
                        $value_select.append($('<option></option>').val(i).html(i))    
                    $value_col.show()     
                    break;
                case "IntegerValue":
                    for (i=0;i<integer_list.length;i++)
                        $value_select.append($('<option></option>').val(integer_list[i]).html(integer_list[i]))      
                    $value_col.show()
                    break;
                case "LocaleValue":
                    for(let key in countrycodes){
                        if(countrycodes.hasOwnProperty(key)){
                            $value_select.append($('<option></option>').val(key).html(countrycodes[key]))
                        }
                    }
                    $value_col.show()
                    break;
                default:
                    break;

            }
            if(options.default){
                $comparator_select.val(options.default.comparator)
                $value_select.val(options.default.val)
            }
        }
    }
</script>