{% extends 'base.html' %}

<h1>Home</h1>

{% block head %}
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/bs4/dt-1.10.18/b-1.5.6/b-colvis-1.5.6/rg-1.1.0/datatables.min.css"/>
 
<script type="text/javascript" src="https://cdn.datatables.net/v/bs4/dt-1.10.18/b-1.5.6/b-colvis-1.5.6/rg-1.1.0/datatables.min.js"></script>
<!--link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/dt-1.10.18/b-1.5.6/rg-1.1.0/sl-1.3.0/datatables.min.css"/>
 
<script type="text/javascript" src="https://cdn.datatables.net/v/dt/dt-1.10.18/b-1.5.6/rg-1.1.0/sl-1.3.0/datatables.min.js"></script-->

{% endblock head %}

{% block body %}
<div class="container-fluid container-big">
    <table id="project_table" class="table striped" style="width:100%">
        <thead>
            <tr>
                <th rowspan="2"></th>
                <th rowspan="2">Name</th>
                <th rowspan="2">Prozent</th>
                <th colspan="2">Datum</th>
                <th rowspan="2"></th>
            </tr>
            <tr>
                <th>Start</th>
                <th>Ende</th>
            </tr>
        </thead>
    </table>    
</div>
<script>        
    $(document).ready( function () {
        surveys = {{ surveys | tojson }};

        var table = $('#project_table').DataTable({
            data: surveys,
            "columns": [ 
                {   "data": null,
                    //defaultContent: "N/A",
                    "searchable": false,
                    "orderable": false,
                },
                { "data": "Title" },
                {
                    "data": null,
                    "render": function(data, type, row){
                        noAssComplete = row["NumberOfAssignmentsCompleted"]
                        noAssMax = row["MaxAssignments"]
                        noAssPending = row['NumberOfAssignmentsPending']
                        percentComplete = noAssComplete/noAssMax*100
                        return noAssComplete+"/"+noAssMax+" ("+percentComplete+"%)P:"+noAssPending
                    },
                    "type": "amount-complete"
                },
                { "data": "CreationTime" },
                { "data": "Expiration" } ,
                {
                    "data": null,
                    defaultContent: "N/A",
                    "orderable": false
                } 
            ],
            "order": [[ 1, 'asc' ]]
        });

        table.rows().every( function(){ //Create 2 child rows and show BOTH( API restriction)
            this.child(
                    [
                        format_info(this.data()), // maybe change so that not added into td
                        format_slide(this.data())
                    ]             
                ).show()
        })

        table.rows().every( function(){ //Now hide the last one (the slider)
            this.child().last().hide()
        })       
        

        $.fn.dataTable.ext.type.order['amount-complete-pre'] = function ( data ) {            
            percentage = data.substring(data.indexOf("(")+1, data.indexOf(")")) // isolate percentage
            return percentage
        };

        table.on( 'order.dt search.dt', function () {
            table.column(0, {search:'applied', order:'applied'}).nodes().each( function (cell, i) {
                cell.innerHTML = i+1;
            } );
        } ).draw();

        $('#project_table tr:has(".info")').on('click', function(){ // if click on info row trigger click on DataTables-ParentRow
            $(this).prev().trigger('click')
        })

        var animation_running = 0;
        $('#project_table tbody tr[role="row"]').on('click', function () {

            if(!animation_running) // wait for both animations to finish
                animation_running = 1
            else
                return

            var tr = $(this).closest('tr');
            var row = table.row(tr);
            var slider_child = row.child().last()

            if ( tr.hasClass("shown") ) {                
                // This row is already open - close it
                $('div.slider', slider_child).slideUp( function () {
                    
                        slider_child.hide();
                        tr.removeClass('shown');
                        animation_running-=0.5

                } );
                $('div.slider', slider_child).parent('td').animate({padding: '0'}, 300, function(){                    
                    animation_running-=0.5
                });
            }
            else {
                slider_child.show();            
                $('div.slider', slider_child).slideDown(function(){
                    tr.addClass('shown');
                    animation_running-=0.5
                });
                $('div.slider', slider_child).parent('td').animate({padding: '0.75rem'}, 300, function(){                    
                    animation_running-=0.5
                });
            }
        });
        
        function format_info ( data ) {
            console.log(data)
            // `d` is the original data object for the row
            return $('<table class="info" cellpadding="5" cellspacing="0" border="0" style="width:80%">'+
                    '<tr>'+
                        '<td>Description:</td>'+
                        '<td>'+data['Description']+'</td>'+
                        '<td style="width:1rem"></td>'+
                        '<td>HITId:</td>'+
                        '<td>'+data['HITId']+'</td>'+
                    '</tr>'+
                    '<tr>'+
                        '<td>Keywords:</td>'+
                        '<td>'+data['Keywords']+'</td>'+
                        '<td style="width:1rem"></td>'+
                        '<td>HITStatus:</td>'+
                        '<td>'+data['HITStatus']+'</td>'+
                    '</tr>'+
                    '<tr>'+
                        '<td>Reward:</td>'+
                        '<td>$'+data['Reward']+'</td>'+
                        '<td style="width:1rem"></td>'+
                        '<td>HITReviewStatus:</td>'+
                        '<td>'+data['HITReviewStatus']+'</td>'+
                    '</tr>'+
                    '<tr>'+
                        '<td>QualificationRequirements:</td>'+
                        '<td>'+data['QualificationRequirements']+'</td>'+
                        '<td style="width:1rem"></td>'+
                        '<td>AssignmentsPending:</td>'+
                        '<td>'+data['NumberOfAssignmentsPending']+'</td>'+
                    '</tr>'+
                '</table>');
        }

        function format_slide ( data ) {
            // `d` is the original data object for the row
            return $('<div class="slider">' +
                '<table cellpadding="5" cellspacing="0" border="0" style="padding-left:50px;">'+
                    '<tr>'+
                        '<td>Full name:</td>'+
                        '<td>'+'placeholder'+'</td>'+
                    '</tr>'+
                    '<tr>'+
                        '<td>Extension number:</td>'+
                        '<td>'+'placeholder'+'</td>'+
                    '</tr>'+
                    '<tr>'+
                        '<td>Extra info:</td>'+
                        '<td>And any further details here (images etc)...</td>'+
                    '</tr>'+
                '</table>'+
            '</div>');
        }

    } );
    </script>
{% endblock body %}

