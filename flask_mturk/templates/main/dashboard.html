{% extends 'base.html' %}

<h1>Home</h1>

{% block head %}
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/bs4/dt-1.10.18/b-1.5.6/b-colvis-1.5.6/rg-1.1.0/datatables.min.css"/> 
<script type="text/javascript" src="https://cdn.datatables.net/v/bs4/dt-1.10.18/b-1.5.6/b-colvis-1.5.6/rg-1.1.0/datatables.min.js"></script>
<!--link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/dt-1.10.18/b-1.5.6/rg-1.1.0/sl-1.3.0/datatables.min.css"/>
 
<script type="text/javascript" src="https://cdn.datatables.net/v/dt/dt-1.10.18/b-1.5.6/rg-1.1.0/sl-1.3.0/datatables.min.js"></script-->

{% endblock head %}

{% block body %}

<div class="modal fade" id="uploadmodal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Placeholder</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" style="padding:2rem 1rem">
                <form method="POST" id="uploadform" novalidate="novalidate" enctype="multipart/form-data">
                    {{ uploadform.hidden_tag() }}
                    {#{ uploadform.hit_id}#}
                    {{ uploadform.file(class="form-control-file") }}
                    <label class="error"></label>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button id="uploadbtn" type="button" class="btn btn-primary">Upload CSV</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="progressmodal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered  modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Placeholder</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="container-fluid"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid container-big">
    <table id="project_table" class="table striped" style="width:100%">
        <thead>
            <tr>
                <th></th>
                <th>Name</th>
                <th>Fortschritt</th>
                <th>Start</th>
                <th>Ende</th>
                <th></th>
                <th></th>
            </tr>
        </thead>
    </table>    
</div>
<script>
    $(document).ready( function () {
        surveys = {{ surveys | tojson }};
        ordering = {{ ordering | tojson }};
        createdhit = {{ createdhit | tojson}};
    });
  
    $.fn.dataTable.ext.type.order['amount-complete-pre'] = function ( data ) {            
        percentage = data.substring(data.indexOf("(")+1, data.indexOf(")")) // isolate percentage
        return percentage
    };
    /* https://datatables.net/plug-ins/api/row().show() */
    $.fn.dataTable.Api.register('row().show()', function() {
        
        var page_info = this.table().page.info();
        // Get row index
        var new_row_index = this.index();
        // Row position
        var row_position = this.table().rows()[0].indexOf( new_row_index );
        // Already on right page ?
        if( row_position >= page_info.start && row_position < page_info.end ) {
            // Return row object
            return this;
        }
        // Find page number
        var page_to_display = Math.floor( row_position / this.table().page.len() );
        // Go to that page
        this.table().page( page_to_display ).draw('page');
        // Return row object
        return this;
    });
    
    $(document).ready( function () {

        render_surveys=[]
        
        for(hit_index in surveys){ // Add HITs that are not to be batched to 
            hit = surveys[hit_index]
            if(hit.hasOwnProperty('RequesterAnnotation') && hit['RequesterAnnotation'].includes('batch'))
                continue
            hit.batched = false
            render_surveys.push(hit)
        }
        
        ordering.forEach((item) => { //TODO change, maybe add group parameter to ordering
            minihits = get_elements_with_value(surveys, "RequesterAnnotation", "batch"+item.batch_id)
            hits_batch_id = item.batch_id
            hits_order = item.hits
            for(hit_index in minihits){
                hit = minihits[hit_index] 
                if(hit.hasOwnProperty("HITId")){ //if hit is not queued it has an ID
                    hit_order = get_element_with_value(hits_order, "id", hit.HITId)
                    hit.position = hit_order.position
                    hit.workers = hit_order.workers
                }
            }
            for(i in hits_order){
                if(hits_order[i].id == null)
                    minihits.push({'batch_id':item.batch_id, 'position':hits_order[i].position, 'workers':hits_order[i].workers})
            }
            hit_group = summarize_minihits(minihits)
            if(minihits.length) // MTURK API processes created hits for a bit -> cannot access instantly, so if we have a hit in DB but not in mturk-query ignore it
                render_surveys.push(hit_group)
        })
    });

    function compare( a, b ) {
        if ( a.position < b.position ){
          return -1;
        }
        if ( a.position > b.position ){
          return 1;
        }
        return 0;
      }

    function summarize_minihits(array){ //take array of minihits and returns hitgroup with an informationoverview
        hitgroup = {}
        hitgroup.NumberOfAssignmentsPending = 0
        hitgroup.NumberOfAssignmentsCompleted = 0
        hitgroup.MaxAssignments = 0
        hitgroup.batched = true
        array.sort(compare)
        for (i = 0; i < array.length; i++){
            if(i == 0){ // the first minihit should never be queued -> can savely access attributes
                hitgroup.CreationTime = array[i].CreationTime
                hitgroup.Title = array[i].Title
                hitgroup.Description = array[i].Description
                hitgroup.Keywords = array[i].Keywords
                hitgroup.HITTypeId = array[i].HITTypeId
                hitgroup.AssignmentDurationInSeconds = array[i].AssignmentDurationInSeconds
                hitgroup.AutoApprovalDelayInSeconds = array[i].AutoApprovalDelayInSeconds
                hitgroup.Reward = array[i].Reward
                hitgroup.QualificationRequirements = array[i].QualificationRequirements
                hitgroup.batch_id = parseInt(array[i].RequesterAnnotation.substr(5))
            }
            if(i == array.length-1){ // if the last hit of a batch is still queued we can only guess the expiration date of the "entire" batch
                if(array[i].hasOwnProperty('CreationTime'))
                    hitgroup.Expiration = array[i].Expiration
                else
                    hitgroup.Expiration = "tbd"
            }
            if(!array[i].hasOwnProperty('CreationTime')){ // unpublished hits only have 2 attributes, workers, position
                hitgroup.MaxAssignments +=array[i].workers
                continue
            }

            hitgroup.NumberOfAssignmentsPending += array[i].NumberOfAssignmentsPending
            hitgroup.NumberOfAssignmentsCompleted += array[i].NumberOfAssignmentsCompleted
            hitgroup.MaxAssignments += array[i].workers
            
            delete array[i].Title
            delete array[i].Description
            delete array[i].Keywords
            delete array[i].AssignmentDurationInSeconds
            delete array[i].AutoApprovalDelayInSeconds
            delete array[i].HITGroupId
            delete array[i].Reward
            delete array[i].QualificationRequirements
            delete array[i].Question
            //delete array[i].RequesterAnnotation
        }
        hitgroup.minihits = array
        return hitgroup
    }

    function get_element_with_value(json, key, value){
        for(item_index in json){
            item = json[item_index]
            if(item.hasOwnProperty(key) && item[key] == value){
                return item
            }
        }
        return null
    }

    function get_elements_with_value(json, key, value){
        list = []
        json.forEach((item) => {
            if(item.hasOwnProperty(key) && item[key] == value)
                list.push(item) 
        });
        return list
    };

    $(document).ready( function () {

        var table = $('#project_table').DataTable({
            data: render_surveys,
            "createdRow": function( row, data, dataIndex ) {
                if (data.batched) {
                    $(row).addClass( 'batched' ) //TODO: work more with jquery data()
                }else{
                    $(row).addClass( 'standard' )
                }
            },
            "columns": [ 
                {   "data": null,
                    defaultContent: "",
                    "searchable": false,
                    "orderable": false,
                },
                { "data": "Title" },
                {
                    "data": null,
                    "render": function(data, type, row){
                        noAssComplete = row.NumberOfAssignmentsCompleted
                        noAssMax = row.MaxAssignments
                        noAssPending = row.NumberOfAssignmentsPending
                        percentComplete = noAssComplete/noAssMax*100
                        return noAssComplete+"/"+noAssMax+" ("+percentComplete+"%)P:"+noAssPending
                    },
                    "type": "amount-complete"
                },
                { "data": "CreationTime" },
                { "data": "Expiration" } ,
                { 
                    "data": null,
                    "visible": false,
                    "render": function(data, type, row){  //This makes the infochild searchable, too
                        return data.Description + data.HITStatus + data.Keywords + data.HITReviewStatus + data.HITId + data.HITTypeId
                    }
                },
                {
                    "data": null,
                    defaultContent: "N/A",
                    "orderable": false,
                    "searchable": false
                } 
            ],
            "order": [[ 1, 'asc' ]]
        });

        // TODO: finish
        // TODO: dont save IDs etc in DOMs but get them via the row.data
        table.rows().every( function(){ //Create 2 child rows and show BOTH(API restriction)
           
            if(this.data().batched){
                this.child(
                        [
                            format_info(this.data()), // maybe change so that not added into td
                            format_slide(this.data().minihits)
                        ]             
                    ).show()
                this.child().first().addClass("info-row")
                this.child().last().hide()
            }else{                
                this.child(format_info(this.data()),'info-row').show() // maybe change so that not added into td       
            }
        })

        table.on( 'order.dt search.dt', function () {
            table.column(0, {search:'applied', order:'applied'}).nodes().each( function (cell, i) {
                cell.innerHTML = i+1;
            } );
        } ).draw();       

        if(createdhit != null){
            table.rows().every( function(){
                // check if either row or sliderchild has ID
                // TODO: wth did I do with get_element_with_value
                data = this.data()
                if( (data.hasOwnProperty("HITId") && data["HITId"] == createdhit) || get_element_with_value(data.minihits,"HITId", createdhit) ){
                    this.show()
                    $row = $(this.node())
                    $('html, body').animate({
                        'scrollTop': $row.offset().top - 500
                    }, 2000, 'swing', function(){
                        $row.addClass("highlight")
                        $row.next().addClass("highlight")
                    })
                }
            })
        }

        $('#project_table tr:has(".info")').on('click', function(event){ // if click on info row trigger click on DataTables-ParentRow
            if($(event.target).is(":button"))
                return            
            $(this).prev().trigger('click')
        })

        var animation_running = 0;
        $('#project_table tbody tr.batched[role="row"]').on('click', function (event) {

            if(!animation_running) // wait for both animations to finish
                animation_running = 1
            else
                return

            var tr = $(this).closest('tr');
            var row = table.row(tr);
            var slider_child = row.child().last()

            if ( tr.hasClass("shown") ) {                
                // This row is already open - close it
                $('div.slider', slider_child).slideUp( function () {
                    
                        slider_child.hide();
                        tr.removeClass('shown');
                        animation_running-=0.5

                } );
                $('div.slider', slider_child).parent('td').animate({padding: '0'}, 300, function(){                    
                    animation_running-=0.5
                });
            }
            else {
                slider_child.show();            
                $('div.slider', slider_child).slideDown(function(){
                    tr.addClass('shown');
                    animation_running-=0.5
                });
                $('div.slider', slider_child).parent('td').animate({padding: '0.75rem'}, 300, function(){                    
                    animation_running-=0.5
                });
            }
        });

        $('.delete-queued').on( 'click', function (event) {
            // should use row.data() instead of accessing html-data
            group_id = $(this).closest('table').data('group-id').substring(5)
            position = $(this).closest('tr').children("td:first").text()
            s = "?group_id="+group_id+"&position="+position
            $.post( "db/delete-queued"+s, function( data ) {
                console.log(data)
              });
            event.stopPropagation()
        } );

        $('#progressmodal').on('show.bs.modal', function(event){
            var modal = $(this)
            var button = $(event.relatedTarget)
            var position = button.data("position")
            var id = button.data("id")
            modal.find(".modal-title").text("Progress for "+position+". HIT")
            contentdiv = modal.find(".modal-body .container-fluid").empty()
            fetch("/list_assignments/"+id)
                .then(function(response){
                    return response.json()
                }).then(function(data){
                    head = $('<div class="row border-bottom">')
                    head.append($('<div class="col-md-1">'))
                        .append($('<div class="col-md-3 text-center">').append('<h6>WorkerID</h6>'))
                        .append($('<div class="col-md-3 text-center">').append('<h6>Answer</h6>'))
                        .append($('<div class="col-md-2 text-center">').append('<h6>Status</h6>'))
                        .append($('<div class="col-md-3 text-center">').append('<h6>Submission Date</h6>'))
                    contentdiv.append(head)
                    data.forEach(function(elem, index){
                        row = $('<div class="row pt-3">')
                        $index = $('<div class="col-md-1 text-center">').text(index+1)
                        worker = $('<div class="col-md-3 text-center">').text(elem.WorkerId)
                        answer = $('<div class="col-md-3 text-center">').text(elem.Answer)
                        ass_status= $('<div class="col-md-2 text-center">').text(elem.AssignmentStatus)
                        sub_date= $('<div class="col-md-3 text-center">').text(elem.SubmitTime)
                        row.append($index).append(worker).append(answer).append(ass_status).append(sub_date)
                        contentdiv.append(row)
                    })
                    if(!data.length){
                        row = $('<div class="row p-5">')
                        row.append('<div class="col-lg-12 text-center"><h2>No Results have been submitted</h2></div>')
                        contentdiv.append(row)
                    }
                        
                })
        })

        $('#uploadmodal').on('show.bs.modal', function(event){
            var modal = $(this)
            var button = $(event.relatedTarget)
            var row = button.closest("tr.info-row").prev()
            var data = table.row(row).data()
            var title = data.Title
            modal.find(".modal-title").text("CSV-Import for\n"+data.Title).css("white-space", "pre")
            $("#uploadmodal #file").removeClass("error")
            $("#uploadmodal label.error").empty()
        });

        $("#uploadbtn").on("click", function(){
            var form = $('#uploadform')[0]
            console.log(form)
            var formData = new FormData(form);
            //$(this).prop("disabled",true);
            //LOADING

            fetch('/upload', { // Your POST endpoint
                method: 'POST',
                body: formData // This is your file object
              }).then( response => response.json())
                .then(json => {
                    console.log(json)
                    if(json.success){
                        $("#uploadmodal #file").removeClass("error")
                        $("#uploadmodal label.error").empty()
                    }
                    else{
                        $("#uploadmodal label.error").empty()
                        $(this).prop("disabled",false);
                        $("#uploadmodal #file").addClass("error")
                        for (i in json.errors){
                            $("#uploadmodal label.error").append(json.errors[i])
                        }
                    }
                })
        })      
        
        function format_info ( data ) {
            // `d` is the original data object for the row            
            if(data.batched)
                query = data.batch_id+'/True'
            else
                query = data.HITId

            exportlink = '<a class="btn btn-primary" role="button" href="/export/'+query+'" download>ExportCSV</a>'

            return $('<table class="info" cellpadding="5" cellspacing="0" border="0" style="width:80%">'+
                    '<tr>'+
                        '<td>Description:</td>'+
                        '<td>'+data['Description']+'</td>'+
                        '<td style="width:1rem"></td>'+
                        '<td>HITId:</td>'+
                        '<td>'+data['HITId']+'</td>'+
                        '<td>'+exportlink+'</td>'+
                    '</tr>'+
                    '<tr>'+
                        '<td>Keywords:</td>'+
                        '<td>'+data['Keywords']+'</td>'+
                        '<td style="width:1rem"></td>'+
                        '<td>HITTypeId:</td>'+
                        '<td>'+data['HITTypeId']+'</td>'+
                        '<td><button type="button" data-toggle="modal" data-target="#uploadmodal">ImportCSV</button></td>'+
                    '</tr>'+
                    '<tr>'+
                        '<td>Reward:</td>'+
                        '<td>$'+data['Reward']+'</td>'+
                        '<td style="width:1rem"></td>'+
                        '<td>HITStatus:</td>'+
                        '<td>'+data['HITStatus']+'</td>'+
                        '<td><button>Pausieren/Fortsetzen</button></td>'+
                    '</tr>'+
                    '<tr>'+
                        '<td>QualificationRequirements:</td>'+
                        '<td>'+data['QualificationRequirements']+'</td>'+
                        '<td style="width:1rem"></td>'+
                        '<td>MiniBatched:</td>'+
                        '<td>'+data['batched']+(data['batch_id']==undefined?"":":"+data['batch_id'])+'</td>'+
                        '<td><button>Abbrechen</button></td>'+
                    '</tr>'+
                '</table>');
        }

        function format_slide ( data ) {
            // `d` is the original data object for the row
            
            //console.log(data)
            group_id = data[0].RequesterAnnotation
            $table = $(' <table data-group-id='+group_id+' cellpadding="5" cellspacing="0" border="0" style="padding-left:50px;">').addClass('minihit-table')
            
            for(i in data){
                hit = data[i]
                if(hit.hasOwnProperty('CreationTime')){
                    $tr = $('<tr data-id='+hit.HITId+' active>')
                    $tr.append($('<td>').addClass('minihittd minihitposition').text(hit.position)) //hit.position should be same as i always
                    $tr.append($('<td>').addClass('minihittd').text(hit.HITStatus))
                    $tr.append($('<td>').addClass('minihittd').text(hit.NumberOfAssignmentsCompleted+'/'+hit.workers+' ,P: '+hit.NumberOfAssignmentsPending))
                    $tr.append($('<td>').addClass('minihittd').text(hit.CreationTime))
                    $tr.append($('<td>').addClass('minihittd').text(hit.Expiration))
                    $progressbtn = $('<button type="button" data-toggle="modal" data-target="#progressmodal">').data("id",hit.HITId).data("position",hit.position)
                        .addClass("btn btn-sm btn-info").append('<i class="fas fa-tasks"></i>')
                    $tr.append($('<td>').addClass('minihittd').append($progressbtn))
                    $table.append($tr)
                }else{
                    $tr = $('<tr inactive>')
                    $tr.append($('<td>').addClass('minihittd').text(hit.position)) //hit.position should be same as i always
                    $tr.append($('<td>').addClass('minihittd').text('Queued'))
                    $tr.append($('<td>').addClass('minihittd').text('0/'+hit.workers))
                    $tr.append($('<td>').addClass('minihittd'))
                    $tr.append($('<td>').addClass('minihittd'))
                    $delbtn = $('<button type=button>').addClass("btn btn-sm btn-danger delete-queued").append('<i class="fa fa-trash"></i>')                   

                    $tr.append($('<td>').addClass('minihittd').append($delbtn))
                    $table.append($tr)
                }
            }
            $slider = $('<div>').addClass('slider').append( $table)
            return $slider
        }

    } );
    
    </script>
{% endblock body %}
