{% extends 'base.html' %}

<h1>Home</h1>

{% block head %}
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/bs4/dt-1.10.18/b-1.5.6/b-colvis-1.5.6/rg-1.1.0/datatables.min.css"/> 
<script type="text/javascript" src="https://cdn.datatables.net/v/bs4/dt-1.10.18/b-1.5.6/b-colvis-1.5.6/rg-1.1.0/datatables.min.js"></script>
<!--link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/dt-1.10.18/b-1.5.6/rg-1.1.0/sl-1.3.0/datatables.min.css"/>
 
<script type="text/javascript" src="https://cdn.datatables.net/v/dt/dt-1.10.18/b-1.5.6/rg-1.1.0/sl-1.3.0/datatables.min.js"></script-->

{% endblock head %}

{% block body %}

<div class="modal fade" id="uploadmodal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Placeholder</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" style="padding:2rem 1rem">
                <form method="POST" id="uploadform" novalidate="novalidate" enctype="multipart/form-data">
                    {{ uploadform.hidden_tag() }}
                    {{ uploadform.file(class="form-control-file") }}
                    <label class="error"></label>
                    <div class="error"></div>                    
                    <div class="success"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button id="uploadbtn" type="button" class="btn btn-primary">Upload CSV</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="progressmodal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered  modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Placeholder</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <table class="progress-table">
                    <thead>
                        <tr class="border-bottom">
                            <th style="width:5%"></th>
                            <th style="width:20%"><h6>WorkerID</h6></th>
                            <th style="width:10%"><h6>Answer</h6></th>
                            <th style="width:10%"><h6>Status</h6></th>
                            <th style="width:10%"><h6>Bonus paid</h6></th>
                            <th style="width:10%"><h6>Time taken</h6></th>
                            <th style="width:20%"><h6>Acceptance</h6></th>
                            <th style="width:20%"><h6>Submission</h6></th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <div id="progress-empty"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid container-big">
    <table id="project_table" class="table striped" style="width:100%">
        <thead>
            <tr>
                <th></th>
                <th>Name</th>
                <th>Fortschritt</th>
                <th>Start</th>
                <th>Ende</th>
                <th></th>
                <th></th>
            </tr>
        </thead>
    </table>    
</div>
<script>
    $(document).ready( function () {
        surveys = {{ surveys | tojson }};
        ordering = {{ ordering | tojson }};
        createdhit = {{ createdhit | tojson}};
    });
  
    $.fn.dataTable.ext.type.order['amount-complete-pre'] = function ( data ) {            
        percentage = data.substring(data.indexOf("(")+1, data.indexOf(")")) // isolate percentage
        return percentage
    };
    /* https://datatables.net/plug-ins/api/row().show() */
    $.fn.dataTable.Api.register('row().show()', function() {
        
        var page_info = this.table().page.info();
        // Get row index
        var new_row_index = this.index();
        // Row position
        var row_position = this.table().rows()[0].indexOf( new_row_index );
        // Already on right page ?
        if( row_position >= page_info.start && row_position < page_info.end ) {
            // Return row object
            return this;
        }
        // Find page number
        var page_to_display = Math.floor( row_position / this.table().page.len() );
        // Go to that page
        this.table().page( page_to_display ).draw('page');
        // Return row object
        return this;
    });
    
    $(document).ready( function () {

        render_surveys=[]
        
        for(hit_index in surveys){ // Add HITs that are not to be batched to 
            hit = surveys[hit_index]
            if(hit.hasOwnProperty('RequesterAnnotation') && hit['RequesterAnnotation'].includes('batch'))
                continue
            hit.batched = false
            render_surveys.push(hit)
        }
        
        //TODO CHANGE THIS 
        ordering.forEach((item) => { //TODO change, maybe add group parameter to ordering
            minihits = get_elements_with_value(surveys, "RequesterAnnotation", "batch"+item.batch_id)
            hits_batch_id = item.batch_id
            hits_order = item.hits
            for(i=0; i<minihits.length; i++){
                hit = minihits[i] 
                if(hit.hasOwnProperty("HITId")){ //if hit is not queued it has an ID
                    hit_order = get_element_with_value(hits_order, "id", hit.HITId)
                    if(hit_order){
                        hit.position = hit_order.position
                        hit.workers = hit_order.workers
                    }else{ // Ignore HITs that dont appear in the hit_order
                        minihits.splice(i, 1);
                        i-=1
                    }
                }
            }
            for(i in hits_order){
                if(hits_order[i].id == null)
                    minihits.push({'batch_id':item.batch_id, 'position':hits_order[i].position, 'workers':hits_order[i].workers})
            }
            hit_group = summarize_minihits(minihits, item.batch_status)
            if(minihits.length) // MTURK API processes created hits for a bit -> cannot access instantly, so if we have a hit in DB but not in mturk-query ignore it
                render_surveys.push(hit_group)
        })
    });

    function compare( a, b ) {
        if ( a.position < b.position ){
          return -1;
        }
        if ( a.position > b.position ){
          return 1;
        }
        return 0;
      }

    function summarize_minihits(array, status){ //take array of minihits and returns hitgroup with an informationoverview
        hitgroup = {}
        hitgroup.NumberOfAssignmentsPending = 0
        hitgroup.NumberOfAssignmentsCompleted = 0
        hitgroup.MaxAssignments = 0
        hitgroup.batched = true
        hitgroup.batch_status = status
        array.sort(compare)
        for (i = 0; i < array.length; i++){
            if(i == 0){ // the first minihit should never be queued -> can savely access attributes
                hitgroup.CreationTime = array[i].CreationTime
                hitgroup.Title = array[i].Title
                hitgroup.Description = array[i].Description
                hitgroup.Keywords = array[i].Keywords
                hitgroup.HITTypeId = array[i].HITTypeId
                hitgroup.AssignmentDurationInSeconds = array[i].AssignmentDurationInSeconds
                hitgroup.AutoApprovalDelayInSeconds = array[i].AutoApprovalDelayInSeconds
                hitgroup.Reward = array[i].Reward
                hitgroup.QualificationRequirements = array[i].QualificationRequirements
                hitgroup.batch_id = parseInt(array[i].RequesterAnnotation.substr(5))
            }
            if(i == array.length-1){ // if the last hit of a batch is still queued we can only guess the expiration date of the "entire" batch
                if(array[i].hasOwnProperty('CreationTime'))
                    hitgroup.Expiration = array[i].Expiration
                else
                    hitgroup.Expiration = "tbd"
            }
            if(!array[i].hasOwnProperty('CreationTime')){ // unpublished hits only have 2 attributes, workers, position
                hitgroup.MaxAssignments +=array[i].workers
                continue
            }

            hitgroup.NumberOfAssignmentsPending += array[i].NumberOfAssignmentsPending
            hitgroup.NumberOfAssignmentsCompleted += array[i].NumberOfAssignmentsCompleted
            hitgroup.MaxAssignments += array[i].workers
            
            delete array[i].Title
            delete array[i].Description
            delete array[i].Keywords
            delete array[i].AssignmentDurationInSeconds
            delete array[i].AutoApprovalDelayInSeconds
            delete array[i].HITGroupId
            delete array[i].Reward
            delete array[i].QualificationRequirements
            delete array[i].Question
        }
        hitgroup.minihits = array
        return hitgroup
    }

    function get_element_with_value(json, key, value){
        for(item_index in json){
            item = json[item_index]
            if(item.hasOwnProperty(key) && item[key] == value){
                return item
            }
        }
        return null
    }

    function get_elements_with_value(json, key, value){
        list = []
        json.forEach((item) => {
            if(item.hasOwnProperty(key) && item[key] == value)
                list.push(item) 
        });
        return list
    };

    $(document).ready( function () {

        var table = $('#project_table').DataTable({
            data: render_surveys,
            "createdRow": function( row, data, dataIndex ) {
                if (data.batched) {
                    $(row).addClass( 'batched' ) //TODO: work more with jquery data()
                }else{
                    $(row).addClass( 'standard' )
                }
            },
            "columns": [ 
                {   "data": null,
                    defaultContent: "",
                    "searchable": false,
                    "orderable": false,
                },
                { "data": "Title" },
                {
                    "data": null,
                    "render": function(data, type, row){
                        noAssComplete = row.NumberOfAssignmentsCompleted
                        noAssMax = row.MaxAssignments
                        noAssPending = row.NumberOfAssignmentsPending
                        percentComplete = noAssComplete/noAssMax*100
                        return noAssComplete+"/"+noAssMax+" ("+percentComplete+"%)P:"+noAssPending
                    },
                    "type": "amount-complete"
                },
                { "data": "CreationTime" },
                { "data": "Expiration" } ,
                { 
                    "data": null,
                    "visible": false,
                    "render": function(data, type, row){  //This makes the infochild searchable, too
                        return data.Description + data.HITStatus + data.Keywords + data.HITReviewStatus + data.HITId + data.HITTypeId
                    }
                },
                {
                    "data": null,
                    defaultContent: "N/A",
                    "orderable": false,
                    "searchable": false
                } 
            ],
            "order": [[ 1, 'asc' ]]
        });

        // TODO: finish
        // TODO: dont save IDs etc in DOMs but get them via the row.data
        table.rows().every( function(){ //Create 2 child rows and show BOTH(API restriction)
           
            if(this.data().batched){
                this.child(
                        [
                            format_info(this.data()), // maybe change so that not added into td
                            format_slide(this.data().minihits)
                        ]             
                    ).show()
                this.child().first().addClass("info-row")
                this.child().last().hide()
            }else{                
                this.child(format_info(this.data()),'info-row').show() // maybe change so that not added into td       
            }
        })

        table.on( 'order.dt search.dt', function () {
            table.column(0, {search:'applied', order:'applied'}).nodes().each( function (cell, i) {
                cell.innerHTML = i+1;
            } );
        } ).draw();       

        if(createdhit != null){
            table.rows().every( function(){
                // check if either row or sliderchild has ID
                // TODO: wth did I do with get_element_with_value
                data = this.data()
                if( (data.hasOwnProperty("HITId") && data["HITId"] == createdhit) || get_element_with_value(data.minihits,"HITId", createdhit) ){
                    this.show()
                    $row = $(this.node())
                    $('html, body').animate({
                        'scrollTop': $row.offset().top - 500
                    }, 2000, 'swing', function(){
                        $row.addClass("highlight")
                        $row.next().addClass("highlight")
                    })
                }
            })
        }

        $('#project_table tr:has(".info")').on('click', function(event){ // if click on info row trigger click on DataTables-ParentRow
            if($(event.target).is(":button"))
                return            
            $(this).prev().trigger('click')
        })

        var animation_running = 0;
        $('#project_table tbody tr.batched[role="row"]').on('click', function (event) {

            if(!animation_running) // wait for both animations to finish
                animation_running = 1
            else
                return

            var tr = $(this).closest('tr');
            var row = table.row(tr);
            var slider_child = row.child().last()

            if ( tr.hasClass("shown") ) {                
                // This row is already open - close it
                $('div.slider', slider_child).slideUp( function () {
                    
                        slider_child.hide();
                        tr.removeClass('shown');
                        animation_running-=0.5

                } );
                $('div.slider', slider_child).parent('td').animate({padding: '0'}, 300, function(){                    
                    animation_running-=0.5
                });
            }
            else {
                slider_child.show();            
                $('div.slider', slider_child).slideDown(function(){
                    tr.addClass('shown');
                    animation_running-=0.5
                });
                $('div.slider', slider_child).parent('td').animate({padding: '0.75rem'}, 300, function(){                    
                    animation_running-=0.5
                });
            }
        });

        $('.delete-queued').on( 'click', function (event) {
            // should use row.data() instead of accessing html-data
            // make this implement a fetch to get the remaining lists and refresh the list
            
            (async () => {
                slide_table = $(this).closest('table')
                group_id = slide_table.data('group-id').substring(5)
                position = $(this).closest('tr').children("td:first").text()
                slide_table.find('button').attr('disabled', 'true')
                const rawResponse = await fetch('/db/delete-queued/'+group_id+'/'+position, {
                  method: 'POST'
                });
                
                const content = await rawResponse.json();
                slide_table.find('button').removeAttr("disabled")
                if(content.success){
                    $(this).closest('tr').remove()
                    slide_table.children('tr').each(function(index){
                        $(this).children('td:first').text(index+1)
                    })
                }
              })();
        } );

        $('.toggle-groupstatus').on('click', function(event){
            (async () => {
                group_id = $(this).closest('table').data('group-id')
                const rawResponse = await fetch('/db/toggle_group_status/'+group_id, {
                  method: 'POST'
                });
                
                const content = await rawResponse.json();
                if (content.success){
                    btn_text = content.status?"Pause":"Continue"
                    $(this).text(btn_text)
                }
              })();
        })

        $('.export-btn').on('click', function (event){
            event.stopPropagation()
        })

        //TODO: TEST WITH MULTIPLE WORKER SUBMISSIONS FOR EACH MINIHIT
        $('#progressmodal').on('show.bs.modal', function(event){
            var modal = $(this)
            var button = $(event.relatedTarget)
            var position = button.data("position")
            var id = button.data("id")
            modal.find(".modal-title").text("Progress for "+position+". HIT")
            modal.find("#progress-empty").empty()
            tbody = modal.find(".modal-body tbody").empty()
            fetch("/list_assignments/"+id)
                .then(function(response){
                    return response.json()
                }).then(function(data){
                    data.forEach(function(elem, index){
                        //could use date to show GMT+2 time
                        acceptTime = new Date(elem.AcceptTime)                        
                        submitTime = new Date(elem.SubmitTime)

                        timeTakenMin = (submitTime - acceptTime) / 1000 / 60  //1000: milli to seconds; 60: seconds to minutes
                        timeTakenRounded = (Math.round(timeTakenMin*10)/10).toFixed(1) // Rounds minutes to 1 digit after comma

                        row = $('<tr>').addClass("border-bottom")
                        row.append($('<td>').text(index+1))
                            .append($('<td>').addClass("worker").text(elem.WorkerId))
                            .append($('<td>').text(elem.Answer))
                            .append($('<td>').text(elem.AssignmentStatus))
                            .append($('<td>').addClass("bonus").text('Loading...'))
                            .append($('<td>').text(timeTakenRounded + 'min'))
                            .append($('<td>').text(elem.AcceptTime))
                            .append($('<td>').text(elem.SubmitTime))
                        tbody.append(row)
                })
                if(!data.length){
                    row = $('<div class="row p-5">')
                    row.append('<div class="col-lg-12 text-center"><h2>No Results have been submitted</h2></div>')
                    modal.find("#progress-empty").append(row)
                }else
                    fetch("/list_payments/"+id).then(function(response){
                        return response.json()
                }).then(function(data){
                    data.forEach(function(elem){
                        // Get WorkerId of BonusPayment-data
                        workerid = elem.WorkerId
                        bonus = elem.BonusAmount
    
                        //look through progressmodaltables rows and change bonus-td if workerIds match
                        $("table.progress-table tbody tr").each(function(){
                            if($(this).find(".worker").text() == workerid)
                                $(this).find(".bonus").text(bonus)
                        })
                    })
                })
            })            
        })

        $('#uploadmodal').on('show.bs.modal', function(event){
            var modal = $(this)
            var button = $(event.relatedTarget)
            // Setting hidden fields that are used to identify the HIT in the backend            
            $("#hit_batched").val(button.data('batched'))
            $("#hit_identifier").val(button.data('identifier'))

            var row = button.closest("tr.info-row").prev()
            var data = table.row(row).data()
            var title = data.Title
            modal.find(".modal-title").text("CSV-Import for\n"+data.Title).css("white-space", "pre")
            $("#uploadmodal #file").removeClass("error")
            $("#uploadmodal label.error").empty()
            $("#uploadmodal div.error").empty()
            $("#uploadmodal div.success").empty()
        });

        $("#uploadbtn").on("click", function(){
            if(!$("#uploadmodal #file").val()){
                $("#uploadmodal label.error").empty()
                $("#uploadmodal label.error").append("This field is required.")                
                $("#uploadmodal #file").addClass("error")
                return
            }

            var form = $('#uploadform')[0]
            var formData = new FormData(form);
            //LOADING

            $('body').addClass("loading")

            fetch('/upload', { // Your POST endpoint
                method: 'POST',
                body: formData
              }).then( response => response.json())
                .then(json => {
                    $('body').removeClass("loading")
                    if(json.success){                        
                        row = $("<div>").addClass("row")
                        col = $("<div>").addClass("col-3")
                        row_one = row.clone()
                        row_one.append(col.clone().text("Approved"))
                               .append(col.clone().text(json.data.approved))
                               .append(col.clone().text("Rejected"))
                               .append(col.clone().text(json.data.rejected))

                        row_two = row.clone()                        
                        row_two.append(col.clone().text("Bonus paid"))
                               .append(col.clone().text("$"+json.data.bonus))
                               .append(col.clone().text("Softblocked"))
                               .append(col.clone().text(json.data.softblocked))
                        row.clone
                        $("#uploadmodal div.success").append(row_two).append(row_one)
                    }
                    else{
                        $("#uploadmodal label.error").empty()
                        $("#uploadmodal div.error").empty()
                        //$(this).prop("disabled",false);
                        $("#uploadmodal #file").addClass("error")
                        if(json.errortype == 'main'){
                            $("#uploadmodal div.error").append('<h4>'+json.errors.main+'</h4>')
                        }else if(json.errortype == 'document'){
                            $("#uploadmodal div.error").append('<h4>Logic-error in CSV<h4>')
                            for (i in json.errors){
                                li = $('<li>').text("Row "+i)
                                ul = $('<ul>')
                                for (j in json.errors[i]){
                                    row_li = $('<li>').text(json.errors[i][j])
                                    ul.append(row_li)
                                }
                                $("#uploadmodal div.error").append($('<ul>').append(li.append(ul)))
                                
                            }
                        }else if(json.errortype == 'form'){
                            for(i in json.errors)
                                $("#uploadmodal label.error").append(json.errors[i]+'<br/>')
                        }
                        
                    }
                })
        })      
        
        function format_info ( data ) {
            // `d` is the original data object for the row            
            toggle_status_btn=""
            group_id=-1
            if(data.batched){
                group_id = data.batch_id
                query = data.batch_id+'/True'
                toggle_status_btn = '<button type="button" class="toggle-groupstatus">'+ (data["batch_status"]?"Pause":"Continue") +'</button>'
                                    
            }
            else
                query = data.HITId

            exportlink = '<a class="btn btn-primary export-btn" role="button" href="/export/'+query+'" download>ExportCSV</a>'
            uploadmodalbtn = $('<button type="button" data-toggle="modal" data-target="#uploadmodal">ImportCSV</button>')
                        .data('batched', data.batched)
                        .data('identifier', data.batched?data.batch_id:data.HITId)
            uploadmodalbtntd = $('<td>')
            uploadmodalbtntd.append(uploadmodalbtn)

            
            tr_one = $('<tr>'+
                        '<td>Description:</td>'+
                        '<td>'+data['Description']+'</td>'+
                        '<td style="width:1rem"></td>'+
                        '<td>HITId:</td>'+
                        '<td>'+data['HITId']+'</td>'+
                        '<td>'+exportlink+'</td>'+
                    '</tr>')

            tr_two = $('<tr>'+
                    '<td>Keywords:</td>'+
                    '<td>'+data['Keywords']+'</td>'+
                    '<td style="width:1rem"></td>'+
                    '<td>HITTypeId:</td>'+
                    '<td>'+data['HITTypeId']+'</td>'+
                '</tr>').append(uploadmodalbtntd)
            
            tr_three = $('<tr>'+
                    '<td>Reward:</td>'+
                    '<td>$'+data['Reward']+'</td>'+
                    '<td style="width:1rem"></td>'+
                    '<td>HITStatus:</td>'+
                    '<td>'+data['HITStatus']+'</td>'+
                    '<td>'+toggle_status_btn+'</td>'+
                '</tr>')

            tr_four = $('<tr>'+
                    '<td>QualificationRequirements:</td>'+
                    '<td>'+data['QualificationRequirements']+'</td>'+
                    '<td style="width:1rem"></td>'+
                    '<td>MiniBatched:</td>'+
                    '<td>'+data['batched']+(data['batch_id']==undefined?"":":"+data['batch_id'])+'</td>'+
                    '<td><button>Abbrechen</button></td>'+
                '</tr>')
            
            return $('<table class="info" cellpadding="5" cellspacing="0" border="0" style="width:80%">').data('group-id', group_id)
                    .append(tr_one).append(tr_two).append(tr_three).append(tr_four)
        }

        function format_slide ( data ) {
            // `d` is the original data object for the row
            
            group_id = data[0].RequesterAnnotation
            $table = $(' <table cellpadding="5" cellspacing="0" border="0" style="padding-left:50px;">').addClass('minihit-table')
            $table.data('group-id', group_id)
            
            for(i in data){
                hit = data[i]
                if(hit.hasOwnProperty('CreationTime')){
                    $tr = $('<tr active>')
                    $tr.append($('<td>').addClass('minihittd minihitposition').text(hit.position)) //hit.position should be same as i always
                    $tr.append($('<td>').addClass('minihittd').text(hit.HITStatus))
                    $tr.append($('<td>').addClass('minihittd').text(hit.NumberOfAssignmentsCompleted+'/'+hit.workers+' ,P: '+hit.NumberOfAssignmentsPending))
                    $tr.append($('<td>').addClass('minihittd').text(hit.CreationTime))
                    $tr.append($('<td>').addClass('minihittd').text(hit.Expiration))
                    $progressbtn = $('<button type="button" data-toggle="modal" data-target="#progressmodal">').data("id",hit.HITId).data("position",hit.position)
                        .addClass("btn btn-sm btn-info").append('<i class="fas fa-tasks"></i>')
                    $tr.append($('<td>').addClass('minihittd').append($progressbtn))
                    $table.append($tr)
                }else{
                    $tr = $('<tr inactive>')
                    $tr.append($('<td>').addClass('minihittd').text(hit.position)) //hit.position should be same as i always
                    $tr.append($('<td>').addClass('minihittd').text('Queued'))
                    $tr.append($('<td>').addClass('minihittd').text('0/'+hit.workers))
                    $tr.append($('<td>').addClass('minihittd'))
                    $tr.append($('<td>').addClass('minihittd'))
                    $delbtn = $('<button type=button>').addClass("btn btn-sm btn-danger delete-queued").append('<i class="fa fa-trash"></i>')                   

                    $tr.append($('<td>').addClass('minihittd').append($delbtn))
                    $table.append($tr)
                }
            }
            $slider = $('<div>').addClass('slider').append( $table)
            return $slider
        }

    } );
    
    </script>
{% endblock body %}
